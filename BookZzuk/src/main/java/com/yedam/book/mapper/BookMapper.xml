<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.book.mapper.BookMapper">

	<select id="getBookList" resultType="BookVO"
		parameterType="hashmap">

		SELECT item_id, cover, title, sale_price, std_price
		from
		(select ROWNUM RNUM, b.* from
		((select * from book
		order by ${sortCol} ${sortMod}) b) 
		where category Like '%${category}%' and title like '%${search}%')
		where RNUM BETWEEN ${page-1}*20+1 AND ${page}*20 
	</select>
	
	
	<select id="getBook" resultType="BookVO" parameterType="int">
		SELECT *
		from
		book
		where item_id = #{item_id}
	</select>

	<select id="getRelatedBook" resultType="BookVO"
		parameterType="int">
		select item_id, cover, title, sale_Price,std_Price
		from
		book
		where
		category like '%'||(substr((SELECT category
		from
		book
		where
		item_id = ${itemId}),-3))||'%'
		AND ROWNUM &lt; 5
		ORDER BY dbms_random.value 
	</select>
	
	<!-- 찜목록 조회 시작 -->
	<select id="getLikeList" resultType="BookVO">
		SELECT b.item_id
			 , cover
			 , title
		 	 , sale_price
			 , std_price
		  FROM member m, book b, book_like bLike
		 WHERE bLike.user_id = m.user_id
		   AND bLike.item_id = b.item_id
		   AND m.user_id = #{uid}
	</select>
	<!-- 찜목록 조회 끝 -->
	<!-- 전체 리스트 조회 시작 -->
	<select id="getAllBook" resultType="BookVO">
		SELECT item_id
		  FROM book
	</select>
	<!-- 전체 리스트 조회 끝 -->
	<!-- 평균 별점 갱신 시작 -->
	<update id="modifyRating">
		UPDATE book
		   SET avg_rating = ( SELECT ROUND(AVG(NVL(rating, 0))), 2)
		   						FROM review
		   					   WHERE item_id = #{itemId} )
		 WHERE item_id = #{itemId}
	</update>
	<!-- 평균 별점 갱신 끝 -->
	<!-- 추천 도서 조회 시작 -->
	<select id="recomanList" resultType="BookVO">
		SELECT *
		  FROM ( SELECT *
		  		   FROM book
		 		  WHERE category IN ( SELECT category
		 					   			FROM book b, book_order o, order_detail d
		 					  		   WHERE o.order_num = d.order_num
		 					    		 AND d.item_id   = b.item_id
		 					    		 AND o.user_id = #{uid}
		 					  		   ORDER BY avg_rating DESC ) )
		 WHERE ROWNUM BETWEEN 1 AND 7
	</select>
	<!-- 추천 도서 조회 끝 -->
	<!-- 화재 도서 조회 시작 -->
	<select id="muchSellList" resultType="BookVO">
		SELECT *
		  FROM book
		 WHERE item_id IN ( SELECT item_id
		         			  FROM order_detail
		       			     GROUP BY item_id
		    		         ORDER BY SUM(item_cnt) DESC )
		   AND ROWNUM BETWEEN 1 AND 10
	</select>
	<!-- 화재 도서 조회 끝 -->
	<!-- 신간 도서 조회 시작 -->
	<select id="newBookList" resultType="BookVO">
		SLELCT a.*
		  FROM ( SLELCT *
		  		   FROM book
		 		  ORDER BY pub_date DESC) a
		 WHERE ROWNUM BETWEEN 1 AND 3
	</select>
	<!-- 신간 도서 조회 끝 -->
	<!-- 리뷰 조회 시작 -->
	<select id="getReview" resultType="ReviewVO">
	</select>
	<!-- 리뷰 조회 끝 -->
	
</mapper>